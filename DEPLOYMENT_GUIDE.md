# Руководство по деплою MoodTrackerBot

## Защита данных при деплое на Render

### Проблема
При выполнении "Clear build cache & deploy" на Render все данные в локальных файлах теряются, так как контейнер пересоздается заново.

### Решение
Используется внешний SSD диск на 1GB, подключенный к `/MoodTrackerBot_data`.

### Конфигурация

#### Переменные окружения
- `RENDER=true` - указывает, что приложение работает в продакшене на Render
- `BOT_TOKEN` - токен Telegram бота

#### Пути к данным
- **Продакшен**: `/MoodTrackerBot_data/` (SSD диск)
- **Локальная разработка**: `./data/` (относительный путь)

#### Файлы данных
- База данных: `mood_tracker.db` (сохраняется постоянно)
- Графики аналитики: создаются временно и автоматически удаляются после отправки

### Оптимизация хранения графиков

#### Проблема
Графики занимают много места (каждый 100-500KB), и на диске 1GB быстро накапливается мусор.

#### Решение
- **Временное хранение**: графики создаются во временной папке системы
- **Автоматическая очистка**: файлы удаляются сразу после отправки пользователю
- **Экономия места**: на SSD диске хранится только база данных

### Автоматическое переключение
Код автоматически определяет среду выполнения:

```python
if os.getenv("RENDER"):
    # Продакшен - используем SSD диск для БД
    DATA_DIR = Path("/MoodTrackerBot_data")
else:
    # Локальная разработка
    DATA_DIR = Path("data")

# Графики всегда создаются временно
temp_dir = tempfile.gettempdir()
```

### Резервное копирование и восстановление данных

#### Создание бэкапа
```bash
python scripts/backup_data.py
```

#### Восстановление данных

**Способ 1: Локальное восстановление на сервере (рекомендуемый)**
```bash
# Если вы находитесь на сервере Render
python scripts/local_restore.py [дата_бэкапа]

# Пример:
python scripts/local_restore.py 20250627_201421
```

**Способ 2: Удаленное восстановление через SSH**
```bash
# С локального компьютера (требует SSH ключ)
python scripts/deploy_restore.py [дата_бэкапа]
```

**Способ 3: Через команду бота**
1. Загрузите файл бэкапа на сервер:
   ```bash
   scp backups/YYYYMMDD_HHMMSS/logs.csv srv-cssvk3ogph6c7399j0gg@ssh.oregon.render.com:/MoodTrackerBot_data/backup_logs.csv
   ```
2. Отправьте боту команду `/restore_backup`

**Способ 4: Ручное восстановление**
```bash
ssh srv-cssvk3ogph6c7399j0gg@ssh.oregon.render.com
cd /opt/render/project/src
python scripts/restore_data.py
```

### Автоматический деплой с сохранением данных

#### Использование скрипта автоматического деплоя:
```bash
./scripts/auto_deploy.sh
```

Скрипт автоматически:
1. Создает бэкап данных
2. Отправляет изменения в Git
3. Ждет завершения деплоя на Render
4. Восстанавливает данные

#### Ручной процесс:
1. Создайте бэкап: `python scripts/backup_data.py`
2. Выполните деплой: `git push origin main`
3. Дождитесь завершения деплоя (2-3 минуты)
4. Восстановите данные: `python scripts/deploy_restore.py`

### Деплой
1. Убедитесь, что диск подключен к `/MoodTrackerBot_data`
2. Установите переменную окружения `RENDER=true`
3. Выполните деплой - данные сохранятся на SSD диске
4. Графики будут создаваться временно и автоматически удаляться

### Проверка
После деплоя:
- База данных сохраняется между перезапусками
- Графики не накапливаются на диске
- Место на SSD используется эффективно
- Исторические данные доступны через аналитику

### Дополнительные ресурсы
- **Подробное руководство по восстановлению**: `BACKUP_RESTORE_GUIDE.md`
- **Скрипты**: папка `scripts/`
  - `backup_data.py` - создание бэкапов
  - `deploy_restore.py` - автоматическое восстановление
  - `restore_data.py` - ручное восстановление
  - `auto_deploy.sh` - полностью автоматический деплой 